#!/bin/sh
jq -r . < /dev/stdin > /tmp/input

export AWS_ACCESS_KEY_ID=$(jq -r .source.aws_access_key_id < /tmp/input)
export AWS_SECRET_ACCESS_KEY=$(jq -r .source.aws_secret_access_key < /tmp/input)
export AWS_DEFAULT_REGION=$(jq -r .source.region < /tmp/input)

IMAGE_ID=$(aws ec2 describe-images \
  --filters \
    'Name=owner-id,Values=099720109477' \
    'Name=is-public,Values=true' \
    'Name=state,Values=available' \
    'Name=name,Values=ubuntu/images/hvm-ssd/ubuntu-trusty-*server*' \
  --query 'sort_by(Images, &CreationDate)[-1].ImageId')
echo "[{\"ami\": \"$IMAGE_ID\"}]"
