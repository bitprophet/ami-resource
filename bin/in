#!/bin/sh
set -eu

jq . < /dev/stdin > /tmp/input

DEST="$1"

AMI=$(jq -r '.version.ami // empty' < /tmp/input)

export AWS_ACCESS_KEY_ID=$(jq -r '.source.aws_access_key_id // empty' < /tmp/input)
export AWS_SECRET_ACCESS_KEY=$(jq -r '.source.aws_secret_access_key // empty' < /tmp/input)
export AWS_DEFAULT_REGION=$(jq -r '.source.region // empty' < /tmp/input)

aws ec2 describe-images --image-ids "$AMI" --query 'Images[0]' \
  | tee "$DEST/output.json" \
  | jq -r '.ImageId' > "$DEST/id"

jq -M '.ImageId as $image | {Name, CreationDate, VirtualizationType, RootDeviceType} | to_entries | {metadata: map({name:.key, value:.value}), version: {ami: $image}}' < "$DEST/output.json" 2>&1
